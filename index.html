<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Olympic Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0b0e14; --chat-bg: #0f121a; --text: #ffffff;
            --pink: #ff47a1; --purple: #9d50bb; --gray: #8b949e;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; justify-content: center; height: 100vh; }
        #chat-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; border-left: 1px solid #30363d; background: var(--chat-bg); }
        .header { padding: 12px 15px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .connected { color: #23d160; font-weight: bold; }
        .connected::before { content: '● '; }
        .event-info { padding: 8px 15px; background: #161b22; font-size: 12px; color: var(--gray); border-bottom: 1px solid #30363d; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .username { color: var(--pink); font-weight: 800; text-transform: uppercase; margin-right: 5px; }
        .system { color: var(--purple); font-weight: bold; }
        .input-area { padding: 15px; border-top: 1px solid #30363d; display: flex; gap: 10px; }
        input { flex: 1; background: #161b22; border: 1px solid #30363d; color: white; padding: 10px; border-radius: 6px; outline: none; }
        button { background: var(--pink); border: none; color: white; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="chat-container">
    <div class="header">
        <span style="font-weight: bold; letter-spacing: 1px;">CHAT</span>
        <span class="connected">CONNECTED</span>
    </div>
    <div class="event-info">
        ⛷️ Men's Super-G | <span style="color: white;">69 viewers</span>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="chatInput" placeholder="Send a message...">
        <button id="sendBtn">SEND</button>
    </div>
</div>

<script>
    const S_URL = 'https://fkkcrphcophmolhkvjnz.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZra2NycGhjb3BobW9saGt2am56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTMwODMsImV4cCI6MjA4NjM4OTA4M30.Bhl89g_ZwlGyj3Eg5mkJZar8ftRh5UdWxDQwH1BiQCQ';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    const msgDiv = document.getElementById('messages');
    const input = document.getElementById('chatInput');

    function addMsg(user, text, isSystem = false) {
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = isSystem ? `<span class="system">SYSTEM:</span> ${text}` : `<span class="username">${user}:</span> ${text}`;
        msgDiv.appendChild(d);
        msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    // 1. Load Last 50 Messages
    async function loadHistory() {
        const { data } = await supabaseClient.from('messages').select('*').order('created_at', { ascending: true }).limit(50);
        if (data) data.forEach(m => addMsg(m.username, m.content));
        addMsg('', 'Welcome to the Olympic Live Chat!', true);
    }

    // 2. Listen for Realtime
    supabaseClient.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, 
        payload => addMsg(payload.new.username, payload.new.content)
    ).subscribe();

    // 3. Send Message
    async function send() {
        const val = input.value.trim();
        if (!val) return;
        const user = "USER_" + Math.floor(Math.random() * 999);
        await supabaseClient.from('messages').insert([{ username: user, content: val }]);
        input.value = '';
    }

    document.getElementById('sendBtn').onclick = send;
    input.onkeydown = (e) => { if(e.key === 'Enter') send(); };
    loadHistory();
</script>
</body>
</html>
