<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPVChat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>Welcome to PPVChat</h2>
            <input type="text" id="username-input" placeholder="Enter Username">
            <button onclick="joinChat()">Start Chatting</button>
        </div>
    </div>

    <div id="chat-screen" style="display:none;">
        <div class="header">
            <span>chat</span>
            <span class="status"><span class="dot"></span> connected</span>
        </div>
        <div id="messages"></div>
        <form id="chat-form">
            <input type="text" id="msg-input" placeholder="Send a message (use :fire: :sad:)">
            <button type="submit">‚û§</button>
        </form>
    </div>

    <script>
        const supabaseUrl = 'https://fkkcrphcophmolhkvjnz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZra2NycGhjb3BobW9saGt2am56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTMwODMsImV4cCI6MjA4NjM4OTA4M30.Bhl89g_ZwlGyj3Eg5mkJZar8ftRh5UdWxDQwH1BiQCQ';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let myUsername = "";
        const emojiMap = {
            ":fire:": "https://media.giphy.com/media/3o72FfM5HJydzaMZOo/giphy.gif",
            ":sad:": "https://media.giphy.com/media/26fpzgfJ0Yh13tWdq/giphy.gif"
        };

        function joinChat() {
            const input = document.getElementById('username-input').value;
            if(input) {
                myUsername = input;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                loadMessages();
                subscribe();
            }
        }

        async function loadMessages() {
            const { data } = await _supabase.from('messages').select('*').order('created_at', { ascending: true });
            data.forEach(addMessageToUI);
        }

        function subscribe() {
            _supabase.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                addMessageToUI(payload.new);
            }).subscribe();
        }

        function addMessageToUI(msg) {
            const div = document.createElement('div');
            div.className = 'message-row';
            
            let tag = "";
            let nameClass = "user-name";
            if (msg.username === "Optimus") { tag = '<span class="tag owner">üîß SYSTEM</span>'; nameClass = "optimus-sparkle"; }
            if (msg.username === "Futbol+") { tag = '<span class="tag mod">üõ°Ô∏è MOD</span>'; nameClass = "futbol-sparkle"; }

            let content = msg.content;
            Object.keys(emojiMap).forEach(key => {
                content = content.replace(new RegExp(key, 'g'), `<img src="${emojiMap[key]}" class="emoji">`);
            });

            div.innerHTML = `${tag} <span class="${nameClass}">${msg.username}:</span> <span class="text">${content}</span>`;
            const box = document.getElementById('messages');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const role = myUsername === "Optimus" ? "owner" : (myUsername === "Futbol+" ? "mod" : "user");
            await _supabase.from('messages').insert([{ username: myUsername, content: input.value, role: role }]);
            input.value = "";
        };
    </script>
</body>
</html>
